<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
html, body {
	height: 100%;
	padding: 0;
	margin: 0;
}
.box-container {
	height: 100%;
    min-height: 100%;
	display: flex;
}

.title-container {
	height: 100%;
	width: 100%;
	background-color: yellow;
}

.title-box {
	color: black;
	text-align: center;
	font-family: sans-serif;
	font-size: 50px;
	justify-content: center;
	padding: 25%; /* Need to change */
}
	
.box {
	text-align: center;
	color: white;
	font-family: sans-serif;
	font-size: 36px;
	padding: 20px;
	
	display: flex;
	flex-direction: column;
    justify-content: center;
}

.legendThreshold {
    font-size: 12px;
    font-family: sans-serif;
}

.feature.active {
    fill: orange;
}

.mesh {
  fill: none;
  stroke: #fff;
  stroke-linecap: round;
  stroke-linejoin: round;
}

.country {
  stroke: #fff;
}

.caption {
    fill: #000;
    font-weight: bold;
}

line {
    stroke: tomato;
    stroke-width: 3px;
}

.box-1 {
	width: 8%;
}

.box-2 {
	width: 61%;
}

.box-3 {
	background-color: red;
	width: 31%;
  }
}

</style>
</head>
<body>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script src="https://unpkg.com/versor@0.0.3/build/versor.min.js"></script>
<script src="https://unpkg.com/d3-inertia@0.0.5/build/d3-inertia.min.js"></script>

<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.24.0/d3-legend.js"></script>

<!-- StoryTelling form - 1st page for Title and other content, 2nd Page for the visualization  -->
<!-- If needed to add another page, just copy the title container and change the name of the classes -->
<div class="title-container">
	<div class="title-box">
		This is title page!
	</div>
</div>

<div class="box-container">
	<div class="box box-1"></div>
	<div class="box box-2"></div>
	<div class="box box-3">box 3</div>
</div>

<script>
	var width = $(".box.box-2").width(), height = $(".box.box-2").height(), active = d3.select(null);

	var previousCountryClicked = null;

    var svg = d3.select(".box.box-2").append("svg")
        .attr("width", width)
        .attr("height", height)
        .on("click", stopped, true);

    var g = svg.append('g')

    // Can change the scale and extent of the zoom
    var zoom = d3.zoom()
        .scaleExtent([1, 12])
        .on("zoom", zoomed);

    // Changing the scale will change the size - height and width of globe
    var projection = d3.geoOrthographic()
        .scale(d3.min([width / 2, height / 2]))
        .translate([width / 2, height / 2])
        .precision(.1);

    var path = d3.geoPath()
        .projection(projection);

    //Data and color scale and legend
    var colorScheme = d3.schemeReds[6];
    colorScheme.unshift("#eee");
    var colorScale = d3.scaleThreshold()
        .domain([1, 6, 11, 26, 101, 1001])
        .range(colorScheme);

    // Getting the Legend and setting the color scale on the legend
    var svg_legend = d3.select(".box.box-1").append("svg")
    var g_legend = svg_legend.append("g")
        .attr("class", "legendThreshold")
        .attr("transform", "translate(10,20)");
    g_legend.append("text")
        .attr("class", "caption")
        .attr("x", 0)
        .attr("y", -4)
        .text("Legend");
    var labels = ['0', '1-5', '6-10', '11-25', '26-100', '101-1000', '> 1000'];
    var legend = d3.legendColor()
        .labels(function (d) { return labels[d.i]; })
        .shapePadding(4)
        .scale(colorScale);
    svg_legend.select(".legendThreshold")
        .call(legend);

    // Loading the data for the testing file - Chloropleth
    var data_c = {};
    d3.csv('world/mooc-countries.csv', function(error, data) {
      data.forEach(function(d) {
        data_c[d.code] = d.total;
      });
    });

    // Calling the ready function to render everything even chloropleth
    ready();

    // inertia versor dragging after everything has been rendered
    var inertia = d3.geoInertiaDrag(svg, function() { render(); }, projection);

    // Lat - Long Coordinates for Nigeria - Example
    var coordinates = {};
    coordinates['NGA'] = [[13.5, 4.5]];

    function ready() {
      d3.json("world/countries.json", function(error, data) {
        if (error) throw error;

        g.selectAll("path")
            .data(topojson.feature(data, data.objects.units).features)
          .enter().append("path")

            // Chloropleth code
            .attr("fill", function (d){
                  // Pull data for particular iso and set color - Not able to fill it
                  d.total = data_c[d.properties.iso3] || 0;
                  return colorScale(d.total);
              })
            // End of Chloropleth code
            .attr("d", path)
            .attr("class", "feature")
            .on("click", clicked);

        // Creates a mesh around the border
        g.append("path")
            .datum(topojson.mesh(data, data.objects.units, function(a, b) { return a !== b; }))
            .attr("class", "mesh")
            .attr("d", path);
      });
    }
    
    function render(){
      update(projection.rotate());
    }

    function update(eulerAngles){
      projection.rotate(eulerAngles);
      svg.selectAll("path").attr("d", path);
    }


    function clicked(d) {
      if (active.node() === this) return reset();
      active.classed("active", false);
      active = d3.select(this).classed("active", true);

      // Get info of the active country/feature
      let active_info = active.node();

      var bounds = path.bounds(d),
          dx = bounds[1][0] - bounds[0][0],
          dy = bounds[1][1] - bounds[0][1],
          x = (bounds[0][0] + bounds[1][0]) / 2,
          y = (bounds[0][1] + bounds[1][1]) / 2,

          // Change the scale to change the zoom when you select a country
          scale = Math.max(1, Math.min(12, 0.9 / Math.max(dx / width, dy / height))),
          translate = [width / 2 - scale * x, height / 2 - scale * y];

      svg.transition()
          .duration(750)
          .call( zoom.transform, d3.zoomIdentity.translate(translate[0],translate[1]).scale(scale) );


      if(active_info.__data__.properties.iso3 in coordinates) {
        if(previousCountryClicked !== null) {
            svg.selectAll('circle').remove();
        }
        // The regions should appear after we zoom in the country
        setTimeout(function() {
            showData(coordinates[active_info.__data__.properties.iso3]);
        }, 751) // Should be more than 750 -> more than duration
      } else {
        if(previousCountryClicked !== null) {
            svg.selectAll('circle').remove();
        }
      }

      previousCountryClicked = active_info.__data__.properties.iso3
    }

    function showData(coordinates) {
        // Add circles to the country which has been selected
        // Removing part is within reset
        svg.append('g').selectAll("circle")
            .data(coordinates).enter()
            .append("circle")
            .attr("cx", function (d) {
                return projection(d)[0];
            })
            .attr("cy", function (d) {
                return projection(d)[1];
            })
            .attr("r", "6px")
            .attr("fill", "red")
            .style("position", "fixed");
    }

    function zoomed() {
      // 1.5 here refers to the stroke width of the borders
      g.style("stroke-width", 1.5 / d3.event.transform.k + "px");
      g.attr("transform", d3.event.transform);
    }

    function reset() {
      active.classed("active", false);
      active = d3.select(null);

      // Remove everything from map which is not selected anymore
      svg.selectAll('circle').remove();

      svg.transition()
          .duration(750)
          .call( zoom.transform, d3.zoomIdentity );
    }

    // If the drag behavior prevents the default click,
    // also stop propagation so we donâ€™t click-to-zoom.
    function stopped() {
      if (d3.event.defaultPrevented) d3.event.stopPropagation();
    }
</script>


</body>
</html>